# TONRODY — AUDIT SOURCE OF TRUTH (v1)

Этот документ является ЕДИНСТВЕННЫМ источником правды для всех агентов,
аудиторов и исполнителей, работающих с репозиторием TONRODY.

Любые изменения, не соответствующие этому документу, считаются ошибочными,
даже если они компилируются или выглядят “улучшением”.

---

## 0. Базовые принципы (НЕОБСУЖДАЕМЫЕ)

- Контракт — единственный источник истины
- Commit–reveal логика НИКОГДА не выносится off-chain
- Backend — read-only индексатор
- UI не принимает решений, а только отображает правила контракта
- Отсутствие секрета = отсутствие Reveal (без исключений)
- Никакие “оптимизации UX” не могут ослаблять честность

---

## 1. Commit–Reveal: криптографические требования

### 1.1 Алгоритм хэширования (ФИКСИРОВАН)

Commit вычисляется ТОЛЬКО так:

commit = SHA-256(secret || lobbyId || playerAddress)

yaml
Копировать код

Требования:

- SHA-256 (НЕ keccak, НЕ sha1, НЕ “hash()” без указания)
- Порядок байтов фиксирован и задокументирован
- Контракт, тесты и UI используют идентичную сериализацию

### 1.2 Требования к секрету

- Минимум 32 байта (256 бит)
- Секрет должен генерироваться через CSPRNG
- Контракт обязан reject-ить reveal с секретом меньшей длины
- UI обязан валидировать длину ДО отправки транзакции

---

## 2. Cancel / Refund — защита от манипуляций

### 2.1 Ограничения cancel()

Cancel разрешён ТОЛЬКО:

- в состоянии OPEN
- ДО первого join

Запрещён:

- после первого join
- в REVEAL
- в FINALIZED

Любая попытка cancel вне разрешённого окна должна revert-иться.

---

## 3. Экономическая честность (HARD RULES)

### 3.1 Инварианты (обязательные)

Во всех сценариях:

- sum(claimable) == totalPot
- fee + payouts == deposits
- no double finalize
- no double claim
- no drain after finalize

### 3.2 Fee policy

- feeBps ∈ [50, 200]
- feeRecipient — отдельный treasury-контракт
- Выплаты ТОЛЬКО pull-based
- Finalize incentive:
  - часть fee начисляется finalizer’у
  - incentive фиксирован и прозрачен

---

## 4. Identity & Anti-Abuse (PRODUCT-GRADE)

### 4.1 Wallet ↔ Telegram binding

- TON Proof обязателен
- Telegram payload валидируется на backend
- Один wallet ↔ один Telegram ID
- Без proof:
  - join запрещён
  - UI обязан явно это показать

### 4.2 Replay & Rate limiting

- Все join/create запросы обязаны иметь Idempotency-Key
- Backend обязан:
  - ограничивать частоту join
  - защищать от replay
- Поведение при превышении лимитов задокументировано

---

## 5. UI Guardrails (ЧЕЛОВЕКОБЕЗОПАСНОСТЬ)

### 5.1 Secret handling

- Хранение: IndexedDB + encryption
- Ключ: `${lobbyAddress}:${walletAddress}`
- Reveal-кнопка:
  - скрыта, если секрет отсутствует
  - неактивна при неверном секрете

### 5.2 Backup / Restore

- Экспорт секрета:
  - QR
  - текст
- Импорт:
  - обязательная валидация commit через getCommit()
- UI НИКОГДА не обещает reveal с другого устройства

---

## 6. Backend / Indexer (READ-ONLY)

- Backend не подписывает tx
- Backend не хранит секреты
- Backend не вычисляет победителя
- Все данные берутся из:
  - Factory registry
  - Lobby getters

---

## 7. Definition of Done (DoD)

Задача считается выполненной ТОЛЬКО если:

- pnpm -C contracts test → зелёный
- Контракт reject-ит слабые секреты
- Cancel невозможно после join
- Commit hash полностью детерминирован и задокументирован
- UI не позволяет потерять средства из-за UX
- Все изменения задокументированы в `/docs`

Любое “частично”, “почти”, “логически” = НЕ СЧИТАЕТСЯ.

---
